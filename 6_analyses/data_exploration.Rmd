---
title: "Initial data exploration"
output: html_notebook
---

This notebook contains code and output from exploring the data to inform cleaning steps and analysis process.

```{r}
library(tidyverse)
library(ggplot2)
library(lubridate)
library(GGally) # for ggpairs to explore correlations
library(psych) # for pairplots to explore correlations
```

# Load and inspect data

## Daily energy data

_Aug 21_

Dataset 1, from https://www.kaggle.com/datasets/emmanuelfwerr/london-homes-energy-data.

```{r}
daily_energy <- read_csv("../3_raw_data/london_energy.csv") %>% 
  janitor::clean_names()
```

```{r}
skimr::skim(daily_energy)
```

3510433 rows x 3 cols

Rows are one date and one household value. 5,566 households over 829 days (2011-11-23 to 2014-02-28)

No missing values in kaggle aggregated energy data

### Energy consumption patterns over all households

#### averaging daily energy consumption (across all households)

_Aug 21_ 

Not sure if mean is appropriate measure here, let's look at histogram of energy consumption values of every household on a single date:

```{r}
# boxplot on 2012-12-31
daily_energy %>%
  filter(date == "2012-12-31") %>% 
  ggplot(aes(x = kwh)) + 
  geom_boxplot()

# histogram on 2012-12-31
daily_energy %>%
  filter(date == "2012-12-31") %>% 
  ggplot() + 
  geom_histogram(aes(x = kwh), bins = 150)
```

Energy consumption on an individual date, frequency of households, is not normally distributed but right-skewed. Median may be a better average daily measure than mean.

#### simple lines

_Aug 21_

```{r}
# median
daily_energy %>% 
  group_by(date) %>% 
  mutate(median_kwh = median(kwh)) %>% 
  ggplot(aes(x = date, y = median_kwh)) +
  geom_line()
```


```{r}
# mean
daily_energy %>% 
  group_by(date) %>% 
  mutate(mean_kwh = mean(kwh)) %>% 
  ggplot(aes(x = date, y = mean_kwh)) +
  geom_line()
```

Definitely some seasonality in energy consumption, whichever average used.

#### Rolling average

_August 22_ 

See classnotes wk7 day 1 (new notes in codeclan_work/flipped... folder) - use package `slider`

First need to convert data to tsibble:

```{r}
library(tsibble)
library(slider)
```
```{r}
# convert data to tsibble
daily_energy_ts <- as_tsibble(daily_energy, key = lc_lid, index = date)
```

```{r}
index_var(daily_energy_ts)
```

```{r}
key_vars(daily_energy_ts)
```

To make rolling average for whole dataset, first find median of all values on a each date (because values are not normally distributed on a single date in December, see above, skewed), then do mean across a 14-day window (set as 7 before, 6 after, only show for complete range).

```{r}
# make df with median for each day
median_all_daily_energy_ts <- daily_energy_ts %>% 
  index_by(date) %>% 
  summarise(median_kwh = median(kwh))
```


```{r}
# calc rolling 14-day mean
median_all_daily_energy_ts <- median_all_daily_energy_ts %>% 
  mutate(kwh_moving_avg = slide_dbl(
    .x = median_kwh,
    .f = ~ mean(.),
    .before = 7,
    .after = 6, # 14-day rolling average
    .complete = TRUE
  ))
```

```{r}
median_all_daily_energy_ts %>% 
  ggplot() + 
  geom_line(aes(x = date, y = median_kwh), colour = "grey") + 
  geom_line(aes(x = date, y = kwh_moving_avg), colour = "red") +
  theme_minimal()
```

Need to look at seasonal decomposition.

#### Seasonal decomposition

_Aug 22_

```{r}
library(feasts)
```

Use the median values

```{r}
median_all_daily_energy_ts %>% 
  autoplot(median_kwh) +
  xlab("Date") + ylab("Median daily energy consumption (kWh)")
```

Interpret:

* looks like higher energy usage in winter months (Dec-Feb), lower in summer months (Jun-Aug) with increase/decrease in between
* this pattern repeats over the 2.5 years data we have available (3 winters, 2 summers)
* there is fluctuation within these times too - a weekly pattern?

```{r}
# look at seasonal pattern
median_all_daily_energy_ts %>% 
  gg_season(median_kwh)
```

Seasonal pattern is consistent year-on-year. Maybe 2014 looks like slightly lower usage? Also note some higher variability in winter 2011 data.
Need to remove last date because values are off? And first date too?

##### trend: weekdays

Look at subseries:

Can see trend for every weekday - does look like Sat & Sun are higher.
```{r}
median_all_daily_energy_ts %>% 
  gg_subseries(y = median_kwh, period = 7)
```
##### UPDATE FROM HERE

```{r}
# look only at winter months
daily_energy_ts %>% 
  mutate(quarter = quarter(date, type = "date_first", fiscal_start = 12)) %>% 
  arrange(quarter) %>% 
  index_by(lc_lid) %>% 
  summarise(median_kwh = median(kwh))

  update_tsibble(key = lc_lid, index = quarter)
  
  filter_index(month(date) %in% c(12,1,2))
  gg_subseries(y = median_kwh, period = 7)
```


When looking for subseries, first change index to season (using quarter) - this doesn't work for subseries, need it to be date format

```{r}
quarterly_energy_ts <- daily_energy_ts %>% 
  # make quarters where Dec is in Q1 of year (adjusted as season not real quarter)
  mutate(quarter = quarter(date, type = "date_first", fiscal_start = 12)) %>% 
  
  update_tsibble(key = NULL, index = quarter) 

index_var(quarterly_energy_ts)


%>%
  update_tsibble(key = lc_lid, index = quarter) %>% 
   index_by(quarter) 
  group_by(lc_lid) %>% 
  summarise(median_kwh_perhh = median(kwh))
  gg_subseries(median_kwh)
```


### Energy consumption patterns within households

#### Individal households

_Aug 21_

Let's look at a few individual households:

```{r}
daily_energy %>% 
  distinct(lc_lid)
```

```{r}
daily_energy %>% 
  filter(lc_lid %in% c("MAC000002", "MAC000058", "MAC000359", "MAC000714", "MAC000933", "MAC000997")) %>% 
  ggplot(aes(x = date, y = kwh, colour = lc_lid)) +
  geom_line() +
  facet_wrap(~lc_lid)
```

Can already see households are behaving differently, some high consumers, others less so; some change over the year, some less so.

Might want to use a rolling average here, e.g. 7-day, to give a smoother line (as above!)

Might also want to consider if there are "types" of household to split the data by, e.g. according to how variable they are in a year, their level of consumption (high/low) - see more below.

#### types of household (by consumption patterns)

_Aug 21_

look to see if there are obvious high/medium/low consumer groups

```{r}
household_alltime_consumption <- daily_energy %>% 
  group_by(lc_lid) %>% 
  summarise(alltime_median_kwh = median(kwh),
            alltime_mean_kwh = mean(kwh))
```

```{r}
household_alltime_consumption
```

```{r}
household_alltime_consumption %>% 
  ggplot() +
  geom_histogram(aes(x = alltime_median_kwh), bins = 200)
```

Look at january or july dates only, when there may be more variation in usage (cold and hot weather)

```{r}
household_jan_jul_consumption <- daily_energy %>% 
  mutate(month = month(date, label = TRUE, abbr = FALSE)) %>% 
  filter(month %in% c("January","July")) %>% 
  group_by(lc_lid, month) %>% 
  summarise(median_kwh = median(kwh),
            mean_kwh = mean(kwh))
```

```{r}
# january medians
household_jan_jul_consumption %>% 
  filter(month == "January") %>% 
  ggplot() +
  geom_histogram(aes(x = median_kwh), bins = 200)

# july medians
household_jan_jul_consumption %>% 
  filter(month == "July") %>% 
  ggplot() +
  geom_histogram(aes(x = median_kwh), bins = 200)
```

Most households have median daily consumption in range 0-20 kWh in both January and July.

```{r}
household_jan_jul_consumption %>% 
  ggplot() +
  geom_boxplot(aes(x = month, y = median_kwh))
```

Maybe energy consumption in January is slightly more than in July. Could test this. Long tail of high energy consumers.

No obvious groups to split into, but could label households above Q3 as "high consumers", below Q1 as "low consumers", and rest as "medium consumers".

```{r}
all_kwh_stats <- daily_energy %>% 
  select(kwh) %>% 
  skimr::skim()

all_kwh_stats %>% 
  colnames()

kwh_q1 <- all_kwh_stats %>% 
  select(numeric.p25) %>% 
  pull()

kwh_q3 <- all_kwh_stats %>% 
  select(numeric.p75) %>% 
  pull()

kwh_q1
kwh_q3
```
Note these are calculated from all dates, not adjusted for jan/july/seasonality and note the date range covers more winters (3) than summers (2).

```{r}
# add household type, can be used as lookup key-value (join with full data)
household_alltime_consumption <- household_alltime_consumption %>% 
  mutate(household_consumption_level = case_when(
    alltime_median_kwh >= kwh_q3 ~ "high",
    alltime_median_kwh > kwh_q1 ~ "average",
    alltime_median_kwh <= kwh_q1 ~ "low",
    .default = NA_character_
  ),
  household_consumption_level = factor(household_consumption_level, levels = c("low", "average", "high")))
```

```{r}
household_alltime_consumption %>% 
  ggplot() +
  geom_boxplot(aes(x = household_consumption_level, y = alltime_median_kwh))
```

```{r}
household_alltime_consumption %>% 
  summarise(count = n(), .by = household_consumption_level)
```

Seems like a potentially useful split of data

```{r}
daily_energy_processed <- left_join(daily_energy, household_alltime_consumption, by = "lc_lid")

daily_energy_processed
```

Look at median energy over time by type:

```{r}
daily_energy_processed_medians <- daily_energy_processed %>% 
  group_by(date, household_consumption_level) %>% 
  summarise(median_kwh = median(kwh)) 

daily_energy_processed_medians %>% 
  arrange(date)

daily_energy_processed_medians %>% 
  ggplot() +
  geom_line(aes(x = date, y = median_kwh, colour = household_consumption_level))
```

There may be a way to group households by consumption in an unsupervised way, i.e. by clustering instead.. tbc

## Daily weather data

Dataset 2, from https://www.kaggle.com/datasets/emmanuelfwerr/london-weather-data.



Ideas:

* types of household - look to see if there are any groups by patterns of consumption (not just overall high/low but variable v fixed over time) - try clustering?
* types of weather days - see if there are clusters of temperature, precipitation, cloud cover, sunshine etc --> categories "mild cloudy rainy day" etc
* convert datetime to season, month, day, weekday


